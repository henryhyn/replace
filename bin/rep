#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
# 字符串替换

require 'optparse'
require 'replace'

# We set default values here.
options = {
}

OptionParser.new do |opts|
  opts.banner = 'Usage: rep [options] method [files]'
  methods = Replace.instance_methods - Replace.superclass.instance_methods
  methods.each do |method|
    opts.banner << "\n  #{method}"
  end
end.parse!

files = '*.md'
files = ARGV[1] if ARGV.length > 1
method = ARGV[0]
Dir[files].map do |file|
  string = File.read(file)
  replace = Replace.new(string)
  unless replace.respond_to?(method)
    puts "Sorry, the object has no the method #{method}, try rep -h to get help."
    exit(0)
  end
  replace.send(method)
  unless File.writable?(file)
    File.open(file).chmod(0644)
  end
  File.write(file, replace.string)
  puts replace.scan unless replace.scan.nil?
end